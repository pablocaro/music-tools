<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone.js Learning Lab</title>
    <style>
        /* ============================================
           RESET & VARIABLES
           ============================================ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #333;
            --accent: #4a9eff;
            --accent-hover: #6bb3ff;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-dim: #808080;
            --border: #404040;
            --success: #4caf50;
            --warning: #ff9800;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* ============================================
           LAYOUT
           ============================================ */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ============================================
           SIDEBAR NAVIGATION
           ============================================ */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 20px;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: var(--text-dim);
        }

        .nav-list {
            list-style: none;
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover:not(.disabled) {
            background: var(--bg-tertiary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            border-left-color: var(--accent);
            color: var(--accent);
        }

        .nav-item.disabled {
            color: var(--text-dim);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .nav-item-icon {
            font-size: 18px;
        }

        .nav-item-text {
            flex: 1;
        }

        .nav-item-badge {
            background: var(--warning);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        /* ============================================
           MAIN CONTENT AREA
           ============================================ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
        }

        .module {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        .module.active {
            display: block;
        }

        .module-header {
            margin-bottom: 30px;
        }

        .module-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .module-header p {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ============================================
           CARDS & SECTIONS
           ============================================ */
        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border-left: 3px solid var(--accent);
        }

        /* ============================================
           CONTROLS
           ============================================ */
        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .control-group select,
        .control-group input[type="range"] {
            width: 100%;
        }

        .control-group select {
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .control-group input[type="range"] {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
        }

        .control-group input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .value-display {
            display: inline-block;
            min-width: 60px;
            text-align: right;
            color: var(--accent);
            font-weight: bold;
            font-size: 14px;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            padding: 12px 20px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* ============================================
           NOTE KEYBOARD
           ============================================ */
        .octave-container {
            margin-bottom: 20px;
        }

        .octave-display {
            text-align: center;
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-weight: 500;
        }

        .keyboard-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .octave-arrow {
            width: 44px;
            height: 44px;
            min-width: 44px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .octave-arrow:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .octave-arrow:active {
            transform: scale(0.95);
        }

        .octave-arrow:disabled {
            background: var(--bg-tertiary);
            color: var(--text-dim);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .note-keyboard {
            display: flex;
            gap: 8px;
            flex: 1;
            justify-content: center;
            max-width: 600px;
        }

        .note-btn {
            padding: 18px 12px;
            background: #f5f5f5;
            border: 2px solid #d0d0d0;
            border-radius: 0 0 6px 6px;
            color: #222;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            flex: 1;
            min-width: 50px;
            max-width: 70px;
            box-shadow: 0 4px 0 #b0b0b0;
        }

        .note-btn:hover {
            background: #e8e8e8;
            border-color: var(--accent);
        }

        .note-btn:active,
        .note-btn.playing {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3a8eef;
        }

        .note-btn .key-hint {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 10px;
            color: #888;
            font-weight: normal;
        }

        .note-btn.playing .key-hint {
            color: rgba(255, 255, 255, 0.7);
        }

        /* ============================================
           INFO BOXES
           ============================================ */
        .info-box {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid var(--accent);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-box h4 {
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        /* ============================================
           STUB MODULE
           ============================================ */
        .stub-content {
            text-align: center;
            padding: 60px 20px;
        }

        .stub-content h3 {
            font-size: 28px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .stub-content p {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stub-content .coming-soon {
            display: inline-block;
            margin-top: 20px;
            padding: 8px 16px;
            background: var(--warning);
            color: #fff;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        /* ============================================
           MOBILE MENU BUTTON
           ============================================ */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 44px;
            height: 44px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .menu-toggle span {
            display: block;
            width: 22px;
            height: 2px;
            background: #fff;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .menu-toggle.active span:nth-child(1) {
            transform: translateY(7px) rotate(45deg);
        }

        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active span:nth-child(3) {
            transform: translateY(-7px) rotate(-45deg);
        }

        /* Backdrop overlay for mobile menu */
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .sidebar-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-backdrop {
                display: block;
            }

            .main-content {
                padding: 80px 20px 20px;
                width: 100%;
            }

            .keyboard-row {
                gap: 8px;
            }

            .octave-arrow {
                width: 40px;
                height: 40px;
                min-width: 40px;
                font-size: 18px;
            }

            .note-keyboard {
                gap: 5px;
            }

            .note-btn {
                min-width: 40px;
                max-width: 50px;
                padding: 15px 8px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Backdrop for mobile menu -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>Tone.js Lab</h1>
                <p>Interactive Learning</p>
            </div>
            <ul class="nav-list" id="navList">
                <!-- Navigation items will be dynamically inserted -->
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div id="moduleContainer">
                <!-- Modules will be dynamically inserted -->
            </div>
        </main>
    </div>

    <!-- Tone.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script>
        'use strict';

        /* ============================================
           TONE.JS LEARNING LAB
           ============================================

           Architecture:
           - ToneLabApp: Main application controller
           - BaseModule: Base class for all learning modules
           - Individual module classes extend BaseModule
           - Each module manages its own UI, state, and Tone.js objects

           ============================================ */

        // ============================================
        // BASE MODULE CLASS
        // All learning modules inherit from this
        // ============================================
        class BaseModule {
            constructor(id, title, icon) {
                this.id = id;
                this.title = title;
                this.icon = icon;
                this.isStub = false;
            }

            // Called when module becomes active
            mount() {
                console.log(`📚 Loading module: ${this.title}`);
            }

            // Called when module becomes inactive
            unmount() {
                console.log(`👋 Unloading module: ${this.title}`);
            }

            // Generate the HTML content for this module
            render() {
                return `<div class="module-header">
                    <h2>${this.title}</h2>
                    <p>Module content goes here</p>
                </div>`;
            }
        }

        // ============================================
        // BASICS MODULE
        // Teaches fundamental Tone.js concepts
        // ============================================
        class BasicsModule extends BaseModule {
            constructor() {
                super('basics', '🎹 Basics', '🎹');

                // Synth and audio components
                this.synth = null;
                this.filter = null;

                // Octave settings
                this.currentOctave = 4;
                this.minOctave = 2;
                this.maxOctave = 6;

                // Default settings
                this.defaults = {
                    waveform: 'sine',
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 0.8,
                    filterFreq: 5000,
                    volume: -10,
                    octave: 4
                };

                // Current settings (will be loaded from localStorage or defaults)
                this.settings = { ...this.defaults };

                // Key bindings for notes (just note names, octave added dynamically)
                this.keyMap = {
                    'a': 'C', 's': 'D', 'd': 'E', 'f': 'F',
                    'g': 'G', 'h': 'A', 'j': 'B'
                };

                // Touch tracking for swipe gestures
                this.touchStartX = 0;
                this.touchEndX = 0;
            }

            mount() {
                super.mount();
                this.loadSettings();
                this.createAudioChain();
                this.attachEventListeners();
                this.updateAllDisplays();
            }

            unmount() {
                super.unmount();
                this.removeEventListeners();
                this.disposeAudio();
            }

            // Create Tone.js synth and effects chain
            createAudioChain() {
                // Create a lowpass filter to tame harsh frequencies
                this.filter = new Tone.Filter(this.settings.filterFreq, 'lowpass').toDestination();

                // Create a basic synth with configurable envelope
                this.synth = new Tone.Synth({
                    oscillator: { type: this.settings.waveform },
                    envelope: {
                        attack: this.settings.attack,
                        decay: this.settings.decay,
                        sustain: this.settings.sustain,
                        release: this.settings.release
                    }
                }).connect(this.filter);

                // Set volume
                this.synth.volume.value = this.settings.volume;

                console.log('🎵 Audio chain created: Synth → Filter → Destination');
            }

            // Clean up audio resources
            disposeAudio() {
                if (this.synth) {
                    this.synth.dispose();
                    this.synth = null;
                }
                if (this.filter) {
                    this.filter.dispose();
                    this.filter = null;
                }
            }

            // Attach event listeners to controls
            attachEventListeners() {
                // Waveform selector
                const waveform = document.getElementById('basics-waveform');
                if (waveform) {
                    waveform.addEventListener('change', (e) => this.handleWaveformChange(e));
                }

                // ADSR sliders
                const sliders = ['attack', 'decay', 'sustain', 'release', 'filterFreq', 'volume'];
                sliders.forEach(param => {
                    const slider = document.getElementById(`basics-${param}`);
                    if (slider) {
                        slider.addEventListener('input', (e) => this.handleSliderChange(param, e));
                    }
                });

                // Octave controls
                const octaveDown = document.getElementById('basics-octave-down');
                const octaveUp = document.getElementById('basics-octave-up');

                if (octaveDown) {
                    octaveDown.addEventListener('click', () => this.changeOctave(-1));
                }
                if (octaveUp) {
                    octaveUp.addEventListener('click', () => this.changeOctave(1));
                }

                // Swipe gesture support
                const keyboard = document.getElementById('basics-keyboard');
                if (keyboard) {
                    this.touchStartHandler = (e) => this.handleTouchStart(e);
                    this.touchEndHandler = (e) => this.handleTouchEnd(e);
                    keyboard.addEventListener('touchstart', this.touchStartHandler, { passive: true });
                    keyboard.addEventListener('touchend', this.touchEndHandler, { passive: true });
                }

                // Note buttons
                document.querySelectorAll('.note-btn').forEach(btn => {
                    btn.addEventListener('mousedown', (e) => this.playNote(e.target.dataset.note));
                    btn.addEventListener('mouseup', () => this.releaseNote());
                    btn.addEventListener('mouseleave', () => this.releaseNote());

                    // Touch support
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.playNote(e.target.dataset.note);
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.releaseNote();
                    });
                });

                // Reset button
                const resetBtn = document.getElementById('basics-reset');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => this.resetToDefaults());
                }

                // Keyboard support
                this.keydownHandler = (e) => this.handleKeyDown(e);
                this.keyupHandler = (e) => this.handleKeyUp(e);
                document.addEventListener('keydown', this.keydownHandler);
                document.addEventListener('keyup', this.keyupHandler);

                // Update octave display
                this.updateOctaveDisplay();
            }

            removeEventListeners() {
                document.removeEventListener('keydown', this.keydownHandler);
                document.removeEventListener('keyup', this.keyupHandler);

                const keyboard = document.getElementById('basics-keyboard');
                if (keyboard && this.touchStartHandler && this.touchEndHandler) {
                    keyboard.removeEventListener('touchstart', this.touchStartHandler);
                    keyboard.removeEventListener('touchend', this.touchEndHandler);
                }
            }

            // Handle waveform change
            handleWaveformChange(e) {
                this.settings.waveform = e.target.value;
                if (this.synth && this.synth.oscillator) {
                    this.synth.oscillator.type = this.settings.waveform;
                }
                this.saveSettings();
                console.log(`🎚️ Waveform: ${this.settings.waveform}`);
            }

            // Handle slider changes
            handleSliderChange(param, e) {
                const value = parseFloat(e.target.value);
                this.settings[param] = value;

                // Update display
                const display = document.getElementById(`basics-${param}-value`);
                if (display) {
                    if (param === 'filterFreq') {
                        display.textContent = value + ' Hz';
                    } else if (param === 'volume') {
                        display.textContent = value + ' dB';
                    } else {
                        display.textContent = value.toFixed(2) + 's';
                    }
                }

                // Apply to synth
                if (this.synth) {
                    if (param === 'volume') {
                        this.synth.volume.value = value;
                    } else if (param === 'filterFreq') {
                        this.filter.frequency.value = value;
                    } else {
                        // ADSR parameters
                        this.synth.envelope[param] = value;
                    }
                }

                this.saveSettings();
            }

            // Play a note
            async playNote(note) {
                // Ensure Tone.js audio context is started
                await Tone.start();

                if (this.synth) {
                    // Combine note name with current octave
                    const noteWithOctave = `${note}${this.currentOctave}`;
                    this.synth.triggerAttack(noteWithOctave);
                    console.log(`🎵 Playing: ${noteWithOctave}`);

                    // Visual feedback
                    const btn = document.querySelector(`[data-note="${note}"]`);
                    if (btn) btn.classList.add('playing');
                }
            }

            // Release the note
            releaseNote() {
                if (this.synth) {
                    this.synth.triggerRelease();

                    // Remove visual feedback
                    document.querySelectorAll('.note-btn').forEach(btn => {
                        btn.classList.remove('playing');
                    });
                }
            }

            // Change octave
            changeOctave(direction) {
                const newOctave = this.currentOctave + direction;

                if (newOctave >= this.minOctave && newOctave <= this.maxOctave) {
                    this.currentOctave = newOctave;
                    this.settings.octave = newOctave;
                    this.updateOctaveDisplay();
                    this.saveSettings();
                    console.log(`🎼 Octave changed to: ${this.currentOctave}`);
                }
            }

            // Update octave display and button states
            updateOctaveDisplay() {
                const display = document.getElementById('basics-octave-display');
                const downBtn = document.getElementById('basics-octave-down');
                const upBtn = document.getElementById('basics-octave-up');

                if (display) {
                    display.textContent = `Octave ${this.currentOctave}`;
                }

                // Disable buttons at limits
                if (downBtn) {
                    downBtn.disabled = this.currentOctave <= this.minOctave;
                }
                if (upBtn) {
                    upBtn.disabled = this.currentOctave >= this.maxOctave;
                }
            }

            // Handle touch start for swipe detection
            handleTouchStart(e) {
                this.touchStartX = e.changedTouches[0].screenX;
            }

            // Handle touch end for swipe detection
            handleTouchEnd(e) {
                this.touchEndX = e.changedTouches[0].screenX;
                this.handleSwipe();
            }

            // Detect swipe direction and change octave
            handleSwipe() {
                const swipeThreshold = 50; // Minimum distance for swipe
                const diff = this.touchStartX - this.touchEndX;

                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // Swiped left - increase octave
                        this.changeOctave(1);
                    } else {
                        // Swiped right - decrease octave
                        this.changeOctave(-1);
                    }
                }
            }

            // Handle keyboard input
            handleKeyDown(e) {
                if (e.repeat) return; // Ignore key repeat

                // Arrow keys for octave control
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    this.changeOctave(-1);
                    return;
                }
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    this.changeOctave(1);
                    return;
                }

                // Note keys
                const note = this.keyMap[e.key.toLowerCase()];
                if (note) {
                    e.preventDefault();
                    this.playNote(note);
                }
            }

            handleKeyUp(e) {
                const note = this.keyMap[e.key.toLowerCase()];
                if (note) {
                    e.preventDefault();
                    this.releaseNote();
                }
            }

            // Reset to default settings
            resetToDefaults() {
                this.settings = { ...this.defaults };
                this.currentOctave = this.defaults.octave;
                this.updateAllDisplays();
                this.updateOctaveDisplay();
                this.createAudioChain(); // Recreate synth with defaults
                this.saveSettings();
                console.log('🔄 Reset to defaults');
            }

            // Update all UI displays to match current settings
            updateAllDisplays() {
                // Waveform
                const waveform = document.getElementById('basics-waveform');
                if (waveform) waveform.value = this.settings.waveform;

                // Sliders
                const params = ['attack', 'decay', 'sustain', 'release', 'filterFreq', 'volume'];
                params.forEach(param => {
                    const slider = document.getElementById(`basics-${param}`);
                    const display = document.getElementById(`basics-${param}-value`);

                    if (slider) slider.value = this.settings[param];
                    if (display) {
                        const value = this.settings[param];
                        if (param === 'filterFreq') {
                            display.textContent = value + ' Hz';
                        } else if (param === 'volume') {
                            display.textContent = value + ' dB';
                        } else {
                            display.textContent = value.toFixed(2) + 's';
                        }
                    }
                });
            }

            // Save settings to localStorage
            saveSettings() {
                localStorage.setItem('tonejs-lab-basics', JSON.stringify(this.settings));
            }

            // Load settings from localStorage
            loadSettings() {
                const saved = localStorage.getItem('tonejs-lab-basics');
                if (saved) {
                    try {
                        this.settings = { ...this.defaults, ...JSON.parse(saved) };
                        // Load octave setting
                        if (this.settings.octave) {
                            this.currentOctave = this.settings.octave;
                        }
                        console.log('📂 Settings loaded from localStorage');
                    } catch (e) {
                        console.warn('Failed to load settings, using defaults');
                        this.settings = { ...this.defaults };
                    }
                }
            }

            render() {
                return `
                    <div class="module-header">
                        <h2>🎹 Basics</h2>
                        <p>Learn the fundamentals of Tone.js: creating sounds, shaping them with envelopes, and adding filters.</p>
                    </div>

                    <!-- Introduction -->
                    <div class="info-box">
                        <h4>Welcome to Tone.js!</h4>
                        <p>Tone.js is a Web Audio framework for creating interactive music. In this module, you'll learn how to create a simple synthesizer, play notes, and control its sound.</p>
                    </div>

                    <!-- Note Playing Section -->
                    <div class="section">
                        <h3>Play Notes</h3>
                        <div class="section-description">
                            Click the buttons or use your keyboard (A, S, D, F, G, H, J) to play notes. Use arrows or swipe to change octaves.
                        </div>

                        <div class="octave-container">
                            <div class="octave-display" id="basics-octave-display">Octave 4</div>
                            <div class="keyboard-row">
                                <button class="octave-arrow" id="basics-octave-down" aria-label="Previous octave">◀</button>
                                <div class="note-keyboard" id="basics-keyboard">
                                    <button class="note-btn" data-note="C">C<span class="key-hint">A</span></button>
                                    <button class="note-btn" data-note="D">D<span class="key-hint">S</span></button>
                                    <button class="note-btn" data-note="E">E<span class="key-hint">D</span></button>
                                    <button class="note-btn" data-note="F">F<span class="key-hint">F</span></button>
                                    <button class="note-btn" data-note="G">G<span class="key-hint">G</span></button>
                                    <button class="note-btn" data-note="A">A<span class="key-hint">H</span></button>
                                    <button class="note-btn" data-note="B">B<span class="key-hint">J</span></button>
                                </div>
                                <button class="octave-arrow" id="basics-octave-up" aria-label="Next octave">▶</button>
                            </div>
                        </div>
                    </div>

                    <!-- Waveform Selection -->
                    <div class="section">
                        <h3>Waveform</h3>
                        <div class="section-description">
                            The oscillator's waveform determines the tone color. Sine is pure and soft, triangle is mellow, square is hollow and buzzy, sawtooth is bright and rich.
                        </div>
                        <div class="control-group">
                            <label>Oscillator Type</label>
                            <select id="basics-waveform">
                                <option value="sine">Sine Wave (Pure & Soft)</option>
                                <option value="triangle">Triangle (Mellow)</option>
                                <option value="square">Square (Buzzy)</option>
                                <option value="sawtooth">Sawtooth (Bright)</option>
                            </select>
                        </div>
                    </div>

                    <!-- ADSR Envelope -->
                    <div class="section">
                        <h3>Envelope (ADSR)</h3>
                        <div class="section-description">
                            The envelope shapes how a note evolves over time. Attack = how quickly it reaches full volume, Decay = how quickly it falls to the sustain level, Sustain = the held volume level, Release = how quickly it fades after you let go.
                        </div>

                        <div class="control-group">
                            <label>Attack: <span class="value-display" id="basics-attack-value">0.05s</span></label>
                            <input type="range" id="basics-attack" min="0.001" max="2" step="0.01" value="0.05">
                        </div>

                        <div class="control-group">
                            <label>Decay: <span class="value-display" id="basics-decay-value">0.1s</span></label>
                            <input type="range" id="basics-decay" min="0.001" max="2" step="0.01" value="0.1">
                        </div>

                        <div class="control-group">
                            <label>Sustain: <span class="value-display" id="basics-sustain-value">0.30s</span></label>
                            <input type="range" id="basics-sustain" min="0" max="1" step="0.01" value="0.3">
                        </div>

                        <div class="control-group">
                            <label>Release: <span class="value-display" id="basics-release-value">0.80s</span></label>
                            <input type="range" id="basics-release" min="0.001" max="3" step="0.01" value="0.8">
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="section">
                        <h3>Filter</h3>
                        <div class="section-description">
                            A lowpass filter cuts off high frequencies above the cutoff point, making the sound darker and warmer. Lower values = darker sound.
                        </div>
                        <div class="control-group">
                            <label>Cutoff Frequency: <span class="value-display" id="basics-filterFreq-value">5000 Hz</span></label>
                            <input type="range" id="basics-filterFreq" min="100" max="10000" step="100" value="5000">
                        </div>
                    </div>

                    <!-- Volume -->
                    <div class="section">
                        <h3>Volume</h3>
                        <div class="section-description">
                            Master volume control in decibels (dB). 0 dB is maximum, negative values reduce volume.
                        </div>
                        <div class="control-group">
                            <label>Volume: <span class="value-display" id="basics-volume-value">-10 dB</span></label>
                            <input type="range" id="basics-volume" min="-40" max="0" step="1" value="-10">
                        </div>
                    </div>

                    <!-- Reset -->
                    <div class="section">
                        <button class="btn btn-secondary" id="basics-reset">Reset to Defaults</button>
                    </div>
                `;
            }
        }

        // ============================================
        // STUB MODULES (Future Implementation)
        // ============================================

        class SequencerModule extends BaseModule {
            constructor() {
                super('sequencer', '⏱️ Sequencer & Transport', '⏱️');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>⏱️ Sequencer & Transport</h3>
                        <p>Learn how to create patterns and sequences using Tone.Transport</p>
                        <p>Topics: Step sequencer, Transport controls, timing, loops, scheduling</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        class FXModule extends BaseModule {
            constructor() {
                super('fx', '✨ FX & Modulation', '✨');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>✨ FX & Modulation</h3>
                        <p>Add effects and modulation to bring your sounds to life</p>
                        <p>Topics: Reverb, delay, distortion, chorus, LFOs, modulation routing</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        class DronesModule extends BaseModule {
            constructor() {
                super('drones', '🎶 Drones & Octaves', '🎶');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>🎶 Drones & Octaves</h3>
                        <p>Create sustained tones and explore octave relationships</p>
                        <p>Topics: Sustained notes, octave control, polyphony, voice stacking</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        class VisualizationModule extends BaseModule {
            constructor() {
                super('visualization', '📊 Visualization', '📊');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>📊 Visualization</h3>
                        <p>See your sound with waveform and FFT visualizations</p>
                        <p>Topics: Tone.Waveform, Tone.FFT, canvas drawing, real-time audio viz</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        class MIDIModule extends BaseModule {
            constructor() {
                super('midi', '🎹 MIDI Input', '🎹');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>🎹 MIDI Input</h3>
                        <p>Connect MIDI controllers and keyboards to Tone.js</p>
                        <p>Topics: Web MIDI API, note on/off, velocity, CC mapping</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        class AdvancedModule extends BaseModule {
            constructor() {
                super('advanced', '🚀 Advanced', '🚀');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>🚀 Advanced Topics</h3>
                        <p>Explore advanced synthesis and sampling techniques</p>
                        <p>Topics: PolySynth, Sampler, granular synthesis, custom instruments</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        // ============================================
        // MAIN APPLICATION CONTROLLER
        // Manages module switching and navigation
        // ============================================
        class ToneLabApp {
            constructor() {
                this.modules = [];
                this.currentModule = null;
                this.navContainer = document.getElementById('navList');
                this.contentContainer = document.getElementById('moduleContainer');

                this.init();
            }

            init() {
                // Register all modules
                this.registerModule(new BasicsModule());
                this.registerModule(new SequencerModule());
                this.registerModule(new FXModule());
                this.registerModule(new DronesModule());
                this.registerModule(new VisualizationModule());
                this.registerModule(new MIDIModule());
                this.registerModule(new AdvancedModule());

                // Build navigation
                this.buildNavigation();

                // Setup mobile menu
                this.setupMobileMenu();

                // Load first module
                this.switchToModule('basics');

                console.log('🚀 Tone.js Learning Lab initialized');
            }

            // Setup mobile menu toggle
            setupMobileMenu() {
                const menuToggle = document.getElementById('menuToggle');
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('sidebarBackdrop');

                if (!menuToggle || !sidebar || !backdrop) return;

                // Toggle menu
                const toggleMenu = () => {
                    const isOpen = sidebar.classList.contains('open');

                    if (isOpen) {
                        sidebar.classList.remove('open');
                        backdrop.classList.remove('active');
                        menuToggle.classList.remove('active');
                    } else {
                        sidebar.classList.add('open');
                        backdrop.classList.add('active');
                        menuToggle.classList.add('active');
                    }
                };

                // Menu button click
                menuToggle.addEventListener('click', toggleMenu);

                // Backdrop click closes menu
                backdrop.addEventListener('click', toggleMenu);

                // Close menu when nav item clicked (on mobile)
                this.navContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.nav-item') && !e.target.closest('.nav-item').classList.contains('disabled')) {
                        // Small delay to let the click register
                        setTimeout(() => {
                            if (window.innerWidth <= 768) {
                                toggleMenu();
                            }
                        }, 200);
                    }
                });
            }

            // Register a new module
            registerModule(module) {
                this.modules.push(module);
            }

            // Build the navigation sidebar
            buildNavigation() {
                this.navContainer.innerHTML = '';

                this.modules.forEach(module => {
                    const navItem = document.createElement('li');
                    navItem.className = 'nav-item';
                    if (module.isStub) navItem.classList.add('disabled');
                    navItem.dataset.moduleId = module.id;

                    navItem.innerHTML = `
                        <span class="nav-item-icon">${module.icon}</span>
                        <span class="nav-item-text">${module.title}</span>
                        ${module.isStub ? '<span class="nav-item-badge">Soon</span>' : ''}
                    `;

                    if (!module.isStub) {
                        navItem.addEventListener('click', () => this.switchToModule(module.id));
                    }

                    this.navContainer.appendChild(navItem);
                });
            }

            // Switch to a different module
            switchToModule(moduleId) {
                // Find the module
                const module = this.modules.find(m => m.id === moduleId);
                if (!module || module.isStub) return;

                // Unmount current module
                if (this.currentModule) {
                    this.currentModule.unmount();
                }

                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.moduleId === moduleId) {
                        item.classList.add('active');
                    }
                });

                // Render new module
                this.contentContainer.innerHTML = `
                    <div class="module active" id="module-${module.id}">
                        ${module.render()}
                    </div>
                `;

                // Mount new module
                this.currentModule = module;
                this.currentModule.mount();
            }
        }

        // ============================================
        // START THE APPLICATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            window.toneLabApp = new ToneLabApp();
        });

        /* ============================================
           ROADMAP FOR FUTURE MODULES
           ============================================

           This section outlines how each stub module would be implemented.
           Each follows the same pattern as BasicsModule.

           -------------------------------------------
           SEQUENCER & TRANSPORT MODULE
           -------------------------------------------
           Purpose: Teach pattern-based music creation and timing

           Key Components:
           - Tone.Transport (global clock/scheduler)
           - Tone.Sequence or Tone.Pattern for note patterns
           - Step sequencer UI (8 or 16 steps)
           - BPM control
           - Play/Pause/Stop controls
           - Step editing (toggle notes on/off)

           Implementation:
           class SequencerModule extends BaseModule {
               - Create Transport controls (start, stop, pause)
               - Build step sequencer grid (16 steps × 4 tracks)
               - Use Tone.Sequence to schedule notes
               - Add BPM slider (60-200)
               - Visual feedback: highlight current step
               - Allow pattern saving/loading
           }

           Teaching Focus:
           - Transport is global (shared across app)
           - Scheduling vs immediate playback
           - Timing and quantization
           - Loop points and repeat

           -------------------------------------------
           FX & MODULATION MODULE
           -------------------------------------------
           Purpose: Add effects and LFO-driven modulation

           Key Components:
           - Effects chain: Reverb, Delay, Distortion, Chorus
           - Tone.LFO for modulation
           - Effect bypass toggles
           - Wet/dry mix controls
           - LFO rate and depth

           Implementation:
           class FXModule extends BaseModule {
               - Create synth → effects chain → destination
               - Add reverb (room size, decay)
               - Add delay (time, feedback)
               - Add distortion (amount)
               - Create LFO → modulate filter cutoff
               - Visual representation of signal flow
           }

           Teaching Focus:
           - Signal routing (connect vs toDestination)
           - Wet/dry mixing
           - LFO modulation targets
           - Effect order matters

           -------------------------------------------
           DRONES & OCTAVES MODULE
           -------------------------------------------
           Purpose: Sustained tones and polyphony

           Key Components:
           - Tone.PolySynth for multiple voices
           - Octave selector (-2 to +2)
           - Drone lock (sustained note)
           - Voice stacking (play multiple notes)
           - Chord builder

           Implementation:
           class DronesModule extends BaseModule {
               - Use PolySynth for polyphony
               - Add octave transpose control
               - Drone toggle locks a note
               - Build chord presets (maj, min, 7th)
               - Visual: show active voices
           }

           Teaching Focus:
           - PolySynth vs monophonic Synth
           - Voice allocation
           - Note stacking and chords
           - Octave relationships

           -------------------------------------------
           VISUALIZATION MODULE
           -------------------------------------------
           Purpose: Real-time audio visualization

           Key Components:
           - Tone.Waveform (time-domain oscilloscope)
           - Tone.FFT (frequency spectrum)
           - Canvas drawing
           - Animation loop

           Implementation:
           class VisualizationModule extends BaseModule {
               - Create canvas element
               - Connect synth → Waveform analyzer
               - requestAnimationFrame loop
               - Draw waveform or FFT
               - Add visualization style toggles
           }

           Teaching Focus:
           - Analyzers don't affect audio (passive)
           - Time vs frequency domain
           - getValue() returns typed array
           - Canvas drawing basics

           -------------------------------------------
           MIDI INPUT MODULE
           -------------------------------------------
           Purpose: Connect external MIDI controllers

           Key Components:
           - navigator.requestMIDIAccess()
           - MIDI message parsing
           - Note on/off → synth
           - Velocity mapping
           - CC to parameter mapping

           Implementation:
           class MIDIModule extends BaseModule {
               - Request MIDI access
               - List available devices
               - Parse note on/off (0x90, 0x80)
               - Map velocity to volume
               - Map CC to filter cutoff
               - Visual: show incoming messages
           }

           Teaching Focus:
           - Web MIDI API (separate from Tone.js)
           - MIDI message structure
           - Note on/off, velocity, CC
           - Mapping MIDI to parameters

           -------------------------------------------
           ADVANCED MODULE
           -------------------------------------------
           Purpose: Complex synthesis and sampling

           Key Components:
           - Tone.Sampler (load audio files)
           - Tone.PolySynth with custom voice
           - Granular synthesis concepts
           - Custom instrument creation

           Implementation:
           class AdvancedModule extends BaseModule {
               - Load samples into Sampler
               - Create PolySynth with FMSynth
               - Build custom instrument class
               - Show signal routing diagrams
               - Performance optimization tips
           }

           Teaching Focus:
           - Sampler vs Synth
           - Creating instrument classes
           - Performance considerations
           - Advanced routing

           -------------------------------------------
           GENERAL IMPLEMENTATION PATTERN
           -------------------------------------------

           Each module follows this structure:

           1. Extend BaseModule
           2. Define constructor with defaults
           3. Implement mount() - create Tone.js objects
           4. Implement unmount() - dispose objects
           5. Implement render() - return HTML string
           6. Add event listeners in mount()
           7. Clean up in unmount()
           8. Save/load state via localStorage

           Module Lifecycle:
           - User clicks nav item
           - App calls currentModule.unmount()
           - App renders new module HTML
           - App calls newModule.mount()

           This ensures clean state management and
           prevents audio resource leaks.

           ============================================ */
    </script>
</body>
</html>
