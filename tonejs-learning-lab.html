<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone.js Learning Lab</title>
    <style>
        /* ============================================
           RESET & VARIABLES
           ============================================ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #333;
            --accent: #4a9eff;
            --accent-hover: #6bb3ff;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-dim: #808080;
            --border: #404040;
            --success: #4caf50;
            --warning: #ff9800;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* ============================================
           LAYOUT
           ============================================ */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ============================================
           SIDEBAR NAVIGATION
           ============================================ */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 20px;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: var(--text-dim);
        }

        .nav-list {
            list-style: none;
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover:not(.disabled) {
            background: var(--bg-tertiary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            border-left-color: var(--accent);
            color: var(--accent);
        }

        .nav-item.disabled {
            color: var(--text-dim);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .nav-item-icon {
            font-size: 18px;
        }

        .nav-item-text {
            flex: 1;
        }

        .nav-item-badge {
            background: var(--warning);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        /* ============================================
           MAIN CONTENT AREA
           ============================================ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            padding-bottom: 180px; /* Space for floating keyboard dock */
        }

        .module {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        .module.active {
            display: block;
        }

        .module-header {
            margin-bottom: 30px;
        }

        .module-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .module-header p {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ============================================
           CARDS & SECTIONS
           ============================================ */
        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border-left: 3px solid var(--accent);
        }

        /* ============================================
           CONTROLS
           ============================================ */
        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .control-group select,
        .control-group input[type="range"] {
            width: 100%;
        }

        .control-group select {
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .control-group input[type="range"] {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
        }

        .control-group input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .value-display {
            display: inline-block;
            min-width: 60px;
            text-align: right;
            color: var(--accent);
            font-weight: bold;
            font-size: 14px;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            padding: 12px 20px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* ============================================
           NOTE KEYBOARD - FLOATING DOCK
           ============================================ */
        .keyboard-dock {
            position: fixed;
            bottom: 0;
            left: 260px;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            z-index: 100;
            padding: 20px;
        }

        .octave-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .octave-display {
            text-align: center;
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-weight: 500;
        }

        .keyboard-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .octave-arrow {
            width: 44px;
            height: 44px;
            min-width: 44px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .octave-arrow:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .octave-arrow:active {
            transform: scale(0.95);
        }

        .octave-arrow:disabled {
            background: var(--bg-tertiary);
            color: var(--text-dim);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .note-keyboard {
            display: flex;
            gap: 8px;
            flex: 1;
            justify-content: center;
            max-width: 600px;
        }

        .note-btn {
            padding: 18px 12px;
            background: #f5f5f5;
            border: 2px solid #d0d0d0;
            border-radius: 0 0 6px 6px;
            color: #222;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            flex: 1;
            min-width: 50px;
            max-width: 70px;
            box-shadow: 0 4px 0 #b0b0b0;
        }

        .note-btn:hover {
            background: #e8e8e8;
            border-color: var(--accent);
        }

        .note-btn:active,
        .note-btn.playing {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3a8eef;
        }

        .note-btn .key-hint {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 10px;
            color: #888;
            font-weight: normal;
        }

        .note-btn.playing .key-hint {
            color: rgba(255, 255, 255, 0.7);
        }

        /* ============================================
           SEQUENCER & TRANSPORT CONTROLS
           ============================================ */
        .transport-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .transport-btn {
            padding: 12px 24px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .transport-btn:hover {
            background: var(--accent-hover);
        }

        .transport-btn.stop {
            background: #dc3545;
        }

        .transport-btn.stop:hover {
            background: #c82333;
        }

        .transport-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-dim);
            cursor: not-allowed;
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sequencer-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .step-cell {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .step-cell:hover {
            border-color: var(--accent);
        }

        .step-cell.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .step-cell.current {
            box-shadow: 0 0 0 3px var(--success);
            animation: pulse 0.3s ease;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ============================================
           FX & MODULATION CONTROLS
           ============================================ */
        .fx-chain {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .fx-unit {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            border: 2px solid var(--border);
        }

        .fx-unit.bypassed {
            opacity: 0.5;
        }

        .fx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .fx-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .bypass-toggle {
            padding: 6px 12px;
            background: var(--success);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bypass-toggle.bypassed {
            background: var(--text-dim);
        }

        .oscillator-mix {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .oscillator-mix h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .oscillators-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .oscillator-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
        }

        .oscillator-card h4 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .osc-control {
            margin-bottom: 12px;
        }

        .osc-control:last-child {
            margin-bottom: 0;
        }

        .osc-control label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .osc-control select {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .osc-control .volume-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .osc-control input[type="range"] {
            width: 100%;
        }

        @media (max-width: 768px) {
            .oscillators-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           DRONES MODULE
           ============================================ */
        .drones-container {
            max-width: 800px;
        }

        .add-drone-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .add-drone-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .add-drone-btn:disabled {
            background: var(--text-dim);
            cursor: not-allowed;
            transform: none;
        }

        .drones-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .drone-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .drone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .drone-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .remove-drone-btn {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
            border: 1px solid #ff6464;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .remove-drone-btn:hover {
            background: rgba(255, 100, 100, 0.3);
        }

        .drone-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .drone-control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .drone-control-group label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drone-control-group select,
        .drone-control-group input[type="range"] {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 4px;
        }

        .drone-control-group select {
            cursor: pointer;
        }

        .volume-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .drone-controls {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           INFO BOXES
           ============================================ */
        .info-box {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid var(--accent);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-box h4 {
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        /* ============================================
           STUB MODULE
           ============================================ */
        .stub-content {
            text-align: center;
            padding: 60px 20px;
        }

        .stub-content h3 {
            font-size: 28px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .stub-content p {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stub-content .coming-soon {
            display: inline-block;
            margin-top: 20px;
            padding: 8px 16px;
            background: var(--warning);
            color: #fff;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        /* ============================================
           MOBILE MENU BUTTON
           ============================================ */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 44px;
            height: 44px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .menu-toggle span {
            display: block;
            width: 22px;
            height: 2px;
            background: #fff;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .menu-toggle.active span:nth-child(1) {
            transform: translateY(7px) rotate(45deg);
        }

        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active span:nth-child(3) {
            transform: translateY(-7px) rotate(-45deg);
        }

        /* Backdrop overlay for mobile menu */
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .sidebar-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-backdrop {
                display: block;
            }

            .main-content {
                padding: 80px 20px 20px;
                padding-bottom: 180px;
                width: 100%;
            }

            .keyboard-dock {
                left: 0;
                padding: 15px;
            }

            .keyboard-row {
                gap: 8px;
            }

            .octave-arrow {
                width: 40px;
                height: 40px;
                min-width: 40px;
                font-size: 18px;
            }

            .note-keyboard {
                gap: 5px;
            }

            .note-btn {
                min-width: 40px;
                max-width: 50px;
                padding: 15px 8px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Backdrop for mobile menu -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>Tone.js Lab</h1>
                <p>Interactive Learning</p>
            </div>
            <ul class="nav-list" id="navList">
                <!-- Navigation items will be dynamically inserted -->
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div id="moduleContainer">
                <!-- Modules will be dynamically inserted -->
            </div>
        </main>
    </div>

    <!-- Floating Keyboard Dock -->
    <div class="keyboard-dock" id="keyboardDock" style="display: none;">
        <!-- Keyboard will be dynamically inserted when Basics module is active -->
    </div>

    <!-- Tone.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script>
        'use strict';

        /* ============================================
           TONE.JS LEARNING LAB
           ============================================

           Architecture:
           - ToneLabApp: Main application controller
           - BaseModule: Base class for all learning modules
           - Individual module classes extend BaseModule
           - Each module manages its own UI, state, and Tone.js objects

           ============================================ */

        // ============================================
        // BASE MODULE CLASS
        // All learning modules inherit from this
        // ============================================
        class BaseModule {
            constructor(id, title, icon) {
                this.id = id;
                this.title = title;
                this.icon = icon;
                this.isStub = false;
            }

            // Called when module becomes active
            mount() {
                console.log(`üìö Loading module: ${this.title}`);
            }

            // Called when module becomes inactive
            unmount() {
                console.log(`üëã Unloading module: ${this.title}`);
            }

            // Generate the HTML content for this module
            render() {
                return `<div class="module-header">
                    <h2>${this.title}</h2>
                    <p>Module content goes here</p>
                </div>`;
            }
        }

        // ============================================
        // BASICS MODULE
        // Teaches fundamental Tone.js concepts
        // ============================================
        class BasicsModule extends BaseModule {
            constructor() {
                super('basics', 'Basics', 'üéπ');

                // Synth and audio components
                this.synth = null;
                this.filter = null;

                // Octave settings
                this.currentOctave = 4;
                this.minOctave = 2;
                this.maxOctave = 6;

                // Default settings
                this.defaults = {
                    waveform: 'sine',
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 0.8,
                    filterFreq: 5000,
                    volume: -10,
                    octave: 4
                };

                // Current settings (will be loaded from localStorage or defaults)
                this.settings = { ...this.defaults };

                // Key bindings for notes (just note names, octave added dynamically)
                this.keyMap = {
                    'a': 'C', 's': 'D', 'd': 'E', 'f': 'F',
                    'g': 'G', 'h': 'A', 'j': 'B'
                };

                // Touch tracking for swipe gestures
                this.touchStartX = 0;
                this.touchEndX = 0;
            }

            mount() {
                super.mount();
                this.loadSettings();
                this.createAudioChain();
                this.showKeyboardDock();
                this.attachEventListeners();
                this.updateAllDisplays();
            }

            unmount() {
                super.unmount();
                this.hideKeyboardDock();
                this.removeEventListeners();
                this.disposeAudio();
            }

            // Show and populate the floating keyboard dock
            showKeyboardDock() {
                const dock = document.getElementById('keyboardDock');
                if (dock) {
                    dock.style.display = 'block';
                    dock.innerHTML = `
                        <div class="octave-container">
                            <div class="octave-display" id="basics-octave-display">Octave 4</div>
                            <div class="keyboard-row">
                                <button class="octave-arrow" id="basics-octave-down" aria-label="Previous octave">‚óÄ</button>
                                <div class="note-keyboard" id="basics-keyboard">
                                    <button class="note-btn" data-note="C">C<span class="key-hint">A</span></button>
                                    <button class="note-btn" data-note="D">D<span class="key-hint">S</span></button>
                                    <button class="note-btn" data-note="E">E<span class="key-hint">D</span></button>
                                    <button class="note-btn" data-note="F">F<span class="key-hint">F</span></button>
                                    <button class="note-btn" data-note="G">G<span class="key-hint">G</span></button>
                                    <button class="note-btn" data-note="A">A<span class="key-hint">H</span></button>
                                    <button class="note-btn" data-note="B">B<span class="key-hint">J</span></button>
                                </div>
                                <button class="octave-arrow" id="basics-octave-up" aria-label="Next octave">‚ñ∂</button>
                            </div>
                        </div>
                    `;
                }
            }

            // Hide the floating keyboard dock
            hideKeyboardDock() {
                const dock = document.getElementById('keyboardDock');
                if (dock) {
                    dock.style.display = 'none';
                    dock.innerHTML = '';
                }
            }

            // Create Tone.js synth and effects chain
            createAudioChain() {
                // Create a lowpass filter to tame harsh frequencies
                this.filter = new Tone.Filter(this.settings.filterFreq, 'lowpass').toDestination();

                // Create a basic synth with configurable envelope
                this.synth = new Tone.Synth({
                    oscillator: { type: this.settings.waveform },
                    envelope: {
                        attack: this.settings.attack,
                        decay: this.settings.decay,
                        sustain: this.settings.sustain,
                        release: this.settings.release
                    }
                }).connect(this.filter);

                // Set volume
                this.synth.volume.value = this.settings.volume;

                console.log('üéµ Audio chain created: Synth ‚Üí Filter ‚Üí Destination');
            }

            // Clean up audio resources
            disposeAudio() {
                if (this.synth) {
                    this.synth.dispose();
                    this.synth = null;
                }
                if (this.filter) {
                    this.filter.dispose();
                    this.filter = null;
                }
            }

            // Attach event listeners to controls
            attachEventListeners() {
                // Waveform selector
                const waveform = document.getElementById('basics-waveform');
                if (waveform) {
                    waveform.addEventListener('change', (e) => this.handleWaveformChange(e));
                }

                // ADSR sliders
                const sliders = ['attack', 'decay', 'sustain', 'release', 'filterFreq', 'volume'];
                sliders.forEach(param => {
                    const slider = document.getElementById(`basics-${param}`);
                    if (slider) {
                        slider.addEventListener('input', (e) => this.handleSliderChange(param, e));
                    }
                });

                // Octave controls
                const octaveDown = document.getElementById('basics-octave-down');
                const octaveUp = document.getElementById('basics-octave-up');

                if (octaveDown) {
                    octaveDown.addEventListener('click', () => this.changeOctave(-1));
                }
                if (octaveUp) {
                    octaveUp.addEventListener('click', () => this.changeOctave(1));
                }

                // Swipe gesture support
                const keyboard = document.getElementById('basics-keyboard');
                if (keyboard) {
                    this.touchStartHandler = (e) => this.handleTouchStart(e);
                    this.touchEndHandler = (e) => this.handleTouchEnd(e);
                    keyboard.addEventListener('touchstart', this.touchStartHandler, { passive: true });
                    keyboard.addEventListener('touchend', this.touchEndHandler, { passive: true });
                }

                // Note buttons
                document.querySelectorAll('.note-btn').forEach(btn => {
                    btn.addEventListener('mousedown', (e) => this.playNote(e.target.dataset.note));
                    btn.addEventListener('mouseup', () => this.releaseNote());
                    btn.addEventListener('mouseleave', () => this.releaseNote());

                    // Touch support
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.playNote(e.target.dataset.note);
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.releaseNote();
                    });
                });

                // Reset button
                const resetBtn = document.getElementById('basics-reset');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => this.resetToDefaults());
                }

                // Keyboard support
                this.keydownHandler = (e) => this.handleKeyDown(e);
                this.keyupHandler = (e) => this.handleKeyUp(e);
                document.addEventListener('keydown', this.keydownHandler);
                document.addEventListener('keyup', this.keyupHandler);

                // Update octave display
                this.updateOctaveDisplay();
            }

            removeEventListeners() {
                document.removeEventListener('keydown', this.keydownHandler);
                document.removeEventListener('keyup', this.keyupHandler);

                const keyboard = document.getElementById('basics-keyboard');
                if (keyboard && this.touchStartHandler && this.touchEndHandler) {
                    keyboard.removeEventListener('touchstart', this.touchStartHandler);
                    keyboard.removeEventListener('touchend', this.touchEndHandler);
                }
            }

            // Handle waveform change
            handleWaveformChange(e) {
                this.settings.waveform = e.target.value;
                if (this.synth && this.synth.oscillator) {
                    this.synth.oscillator.type = this.settings.waveform;
                }
                this.saveSettings();
                console.log(`üéöÔ∏è Waveform: ${this.settings.waveform}`);
            }

            // Handle slider changes
            handleSliderChange(param, e) {
                const value = parseFloat(e.target.value);
                this.settings[param] = value;

                // Update display
                const display = document.getElementById(`basics-${param}-value`);
                if (display) {
                    if (param === 'filterFreq') {
                        display.textContent = value + ' Hz';
                    } else if (param === 'volume') {
                        display.textContent = value + ' dB';
                    } else {
                        display.textContent = value.toFixed(2) + 's';
                    }
                }

                // Apply to synth
                if (this.synth) {
                    if (param === 'volume') {
                        this.synth.volume.value = value;
                    } else if (param === 'filterFreq') {
                        this.filter.frequency.value = value;
                    } else {
                        // ADSR parameters
                        this.synth.envelope[param] = value;
                    }
                }

                this.saveSettings();
            }

            // Play a note
            async playNote(note) {
                // Ensure Tone.js audio context is started
                await Tone.start();

                if (this.synth) {
                    // Combine note name with current octave
                    const noteWithOctave = `${note}${this.currentOctave}`;
                    this.synth.triggerAttack(noteWithOctave);
                    console.log(`üéµ Playing: ${noteWithOctave}`);

                    // Visual feedback
                    const btn = document.querySelector(`[data-note="${note}"]`);
                    if (btn) btn.classList.add('playing');
                }
            }

            // Release the note
            releaseNote() {
                if (this.synth) {
                    this.synth.triggerRelease();

                    // Remove visual feedback
                    document.querySelectorAll('.note-btn').forEach(btn => {
                        btn.classList.remove('playing');
                    });
                }
            }

            // Change octave
            changeOctave(direction) {
                const newOctave = this.currentOctave + direction;

                if (newOctave >= this.minOctave && newOctave <= this.maxOctave) {
                    this.currentOctave = newOctave;
                    this.settings.octave = newOctave;
                    this.updateOctaveDisplay();
                    this.saveSettings();
                    console.log(`üéº Octave changed to: ${this.currentOctave}`);
                }
            }

            // Update octave display and button states
            updateOctaveDisplay() {
                const display = document.getElementById('basics-octave-display');
                const downBtn = document.getElementById('basics-octave-down');
                const upBtn = document.getElementById('basics-octave-up');

                if (display) {
                    display.textContent = `Octave ${this.currentOctave}`;
                }

                // Disable buttons at limits
                if (downBtn) {
                    downBtn.disabled = this.currentOctave <= this.minOctave;
                }
                if (upBtn) {
                    upBtn.disabled = this.currentOctave >= this.maxOctave;
                }
            }

            // Handle touch start for swipe detection
            handleTouchStart(e) {
                this.touchStartX = e.changedTouches[0].screenX;
            }

            // Handle touch end for swipe detection
            handleTouchEnd(e) {
                this.touchEndX = e.changedTouches[0].screenX;
                this.handleSwipe();
            }

            // Detect swipe direction and change octave
            handleSwipe() {
                const swipeThreshold = 50; // Minimum distance for swipe
                const diff = this.touchStartX - this.touchEndX;

                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // Swiped left - increase octave
                        this.changeOctave(1);
                    } else {
                        // Swiped right - decrease octave
                        this.changeOctave(-1);
                    }
                }
            }

            // Handle keyboard input
            handleKeyDown(e) {
                if (e.repeat) return; // Ignore key repeat

                // Arrow keys for octave control
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    this.changeOctave(-1);
                    return;
                }
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    this.changeOctave(1);
                    return;
                }

                // Note keys
                const note = this.keyMap[e.key.toLowerCase()];
                if (note) {
                    e.preventDefault();
                    this.playNote(note);
                }
            }

            handleKeyUp(e) {
                const note = this.keyMap[e.key.toLowerCase()];
                if (note) {
                    e.preventDefault();
                    this.releaseNote();
                }
            }

            // Reset to default settings
            resetToDefaults() {
                this.settings = { ...this.defaults };
                this.currentOctave = this.defaults.octave;
                this.updateAllDisplays();
                this.updateOctaveDisplay();
                this.createAudioChain(); // Recreate synth with defaults
                this.saveSettings();
                console.log('üîÑ Reset to defaults');
            }

            // Update all UI displays to match current settings
            updateAllDisplays() {
                // Waveform
                const waveform = document.getElementById('basics-waveform');
                if (waveform) waveform.value = this.settings.waveform;

                // Sliders
                const params = ['attack', 'decay', 'sustain', 'release', 'filterFreq', 'volume'];
                params.forEach(param => {
                    const slider = document.getElementById(`basics-${param}`);
                    const display = document.getElementById(`basics-${param}-value`);

                    if (slider) slider.value = this.settings[param];
                    if (display) {
                        const value = this.settings[param];
                        if (param === 'filterFreq') {
                            display.textContent = value + ' Hz';
                        } else if (param === 'volume') {
                            display.textContent = value + ' dB';
                        } else {
                            display.textContent = value.toFixed(2) + 's';
                        }
                    }
                });
            }

            // Save settings to localStorage
            saveSettings() {
                localStorage.setItem('tonejs-lab-basics', JSON.stringify(this.settings));
            }

            // Load settings from localStorage
            loadSettings() {
                const saved = localStorage.getItem('tonejs-lab-basics');
                if (saved) {
                    try {
                        this.settings = { ...this.defaults, ...JSON.parse(saved) };
                        // Load octave setting
                        if (this.settings.octave) {
                            this.currentOctave = this.settings.octave;
                        }
                        console.log('üìÇ Settings loaded from localStorage');
                    } catch (e) {
                        console.warn('Failed to load settings, using defaults');
                        this.settings = { ...this.defaults };
                    }
                }
            }

            render() {
                return `
                    <div class="module-header">
                        <h2>Basics</h2>
                        <p>Learn the fundamentals of Tone.js: creating sounds, shaping them with envelopes, and adding filters.</p>
                    </div>

                    <!-- Introduction -->
                    <div class="info-box">
                        <h4>Welcome to Tone.js!</h4>
                        <p>Tone.js is a Web Audio framework for creating interactive music. In this module, you'll learn how to create a simple synthesizer, play notes, and control its sound. The keyboard is pinned at the bottom - play notes while scrolling through controls!</p>
                    </div>

                    <!-- Waveform Selection -->
                    <div class="section">
                        <h3>Waveform</h3>
                        <div class="section-description">
                            The oscillator's waveform determines the tone color. Sine is pure and soft, triangle is mellow, square is hollow and buzzy, sawtooth is bright and rich.
                        </div>
                        <div class="control-group">
                            <label>Oscillator Type</label>
                            <select id="basics-waveform">
                                <option value="sine">Sine Wave (Pure & Soft)</option>
                                <option value="triangle">Triangle (Mellow)</option>
                                <option value="square">Square (Buzzy)</option>
                                <option value="sawtooth">Sawtooth (Bright)</option>
                            </select>
                        </div>
                    </div>

                    <!-- ADSR Envelope -->
                    <div class="section">
                        <h3>Envelope (ADSR)</h3>
                        <div class="section-description">
                            The envelope shapes how a note evolves over time. Attack = how quickly it reaches full volume, Decay = how quickly it falls to the sustain level, Sustain = the held volume level, Release = how quickly it fades after you let go.
                        </div>

                        <div class="control-group">
                            <label>Attack: <span class="value-display" id="basics-attack-value">0.05s</span></label>
                            <input type="range" id="basics-attack" min="0.001" max="2" step="0.01" value="0.05">
                        </div>

                        <div class="control-group">
                            <label>Decay: <span class="value-display" id="basics-decay-value">0.1s</span></label>
                            <input type="range" id="basics-decay" min="0.001" max="2" step="0.01" value="0.1">
                        </div>

                        <div class="control-group">
                            <label>Sustain: <span class="value-display" id="basics-sustain-value">0.30s</span></label>
                            <input type="range" id="basics-sustain" min="0" max="1" step="0.01" value="0.3">
                        </div>

                        <div class="control-group">
                            <label>Release: <span class="value-display" id="basics-release-value">0.80s</span></label>
                            <input type="range" id="basics-release" min="0.001" max="3" step="0.01" value="0.8">
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="section">
                        <h3>Filter</h3>
                        <div class="section-description">
                            A lowpass filter cuts off high frequencies above the cutoff point, making the sound darker and warmer. Lower values = darker sound.
                        </div>
                        <div class="control-group">
                            <label>Cutoff Frequency: <span class="value-display" id="basics-filterFreq-value">5000 Hz</span></label>
                            <input type="range" id="basics-filterFreq" min="100" max="10000" step="100" value="5000">
                        </div>
                    </div>

                    <!-- Volume -->
                    <div class="section">
                        <h3>Volume</h3>
                        <div class="section-description">
                            Master volume control in decibels (dB). 0 dB is maximum, negative values reduce volume.
                        </div>
                        <div class="control-group">
                            <label>Volume: <span class="value-display" id="basics-volume-value">-10 dB</span></label>
                            <input type="range" id="basics-volume" min="-40" max="0" step="1" value="-10">
                        </div>
                    </div>

                    <!-- Reset -->
                    <div class="section">
                        <button class="btn btn-secondary" id="basics-reset">Reset to Defaults</button>
                    </div>
                `;
            }
        }

        // ============================================
        // SEQUENCER & TRANSPORT MODULE
        // Teaches pattern creation and timing
        // ============================================
        class SequencerModule extends BaseModule {
            constructor() {
                super('sequencer', 'Sequencer & Transport', '‚è±Ô∏è');

                // Audio components
                this.synth = null;
                this.sequence = null;

                // Sequencer state
                this.pattern = new Array(16).fill(false); // 16 steps, false = rest
                this.currentStep = -1;
                this.isPlaying = false;

                // Default settings
                this.defaults = {
                    bpm: 120,
                    pattern: new Array(16).fill(false)
                };

                this.settings = { ...this.defaults, pattern: [...this.defaults.pattern] };
            }

            mount() {
                super.mount();
                this.loadSettings();
                this.createAudioChain();
                this.attachEventListeners();
                console.log('üéº Sequencer module loaded');
            }

            unmount() {
                super.unmount();
                this.stop();
                this.disposeAudio();
            }

            createAudioChain() {
                // Create a simple synth for playback
                this.synth = new Tone.Synth({
                    oscillator: { type: 'triangle' },
                    envelope: {
                        attack: 0.005,
                        decay: 0.1,
                        sustain: 0.3,
                        release: 0.1
                    }
                }).toDestination();
                this.synth.volume.value = -10;

                // Set BPM
                Tone.Transport.bpm.value = this.settings.bpm;
            }

            disposeAudio() {
                if (this.sequence) {
                    this.sequence.dispose();
                    this.sequence = null;
                }
                if (this.synth) {
                    this.synth.dispose();
                    this.synth = null;
                }
            }

            attachEventListeners() {
                // Transport controls
                const playBtn = document.getElementById('seq-play');
                const pauseBtn = document.getElementById('seq-pause');
                const stopBtn = document.getElementById('seq-stop');
                const bpmSlider = document.getElementById('seq-bpm');
                const bpmDisplay = document.getElementById('seq-bpm-value');

                if (playBtn) playBtn.addEventListener('click', () => this.play());
                if (pauseBtn) pauseBtn.addEventListener('click', () => this.pause());
                if (stopBtn) stopBtn.addEventListener('click', () => this.stop());

                if (bpmSlider) {
                    bpmSlider.addEventListener('input', (e) => {
                        const bpm = parseInt(e.target.value);
                        Tone.Transport.bpm.value = bpm;
                        this.settings.bpm = bpm;
                        if (bpmDisplay) bpmDisplay.textContent = bpm;
                        this.saveSettings();
                    });
                }

                // Step cells
                document.querySelectorAll('.step-cell').forEach((cell, index) => {
                    cell.addEventListener('click', () => this.toggleStep(index));
                });
            }

            toggleStep(index) {
                this.pattern[index] = !this.pattern[index];
                this.settings.pattern = [...this.pattern];
                this.updateStepDisplay(index);
                this.saveSettings();
            }

            updateStepDisplay(index) {
                const cell = document.querySelector(`.step-cell[data-step="${index}"]`);
                if (cell) {
                    if (this.pattern[index]) {
                        cell.classList.add('active');
                    } else {
                        cell.classList.remove('active');
                    }
                }
            }

            async play() {
                await Tone.start();

                if (!this.sequence) {
                    this.createSequence();
                }

                Tone.Transport.start();
                this.isPlaying = true;
                this.updateTransportButtons();
                console.log('‚ñ∂Ô∏è Playing sequence');
            }

            pause() {
                Tone.Transport.pause();
                this.isPlaying = false;
                this.updateTransportButtons();
                console.log('‚è∏Ô∏è Paused');
            }

            stop() {
                Tone.Transport.stop();
                this.isPlaying = false;
                this.currentStep = -1;
                this.updateCurrentStepDisplay();
                this.updateTransportButtons();
                console.log('‚èπÔ∏è Stopped');
            }

            createSequence() {
                // Create a sequence that plays through our pattern
                this.sequence = new Tone.Sequence((time, step) => {
                    this.currentStep = step;

                    // Update UI on main thread
                    Tone.Draw.schedule(() => {
                        this.updateCurrentStepDisplay();
                    }, time);

                    // Play note if step is active
                    if (this.pattern[step]) {
                        this.synth.triggerAttackRelease('C4', '16n', time);
                    }
                }, [...Array(16).keys()], '16n');

                this.sequence.loop = true;
                this.sequence.start(0);
            }

            updateCurrentStepDisplay() {
                document.querySelectorAll('.step-cell').forEach((cell, index) => {
                    if (index === this.currentStep) {
                        cell.classList.add('current');
                    } else {
                        cell.classList.remove('current');
                    }
                });
            }

            updateTransportButtons() {
                const playBtn = document.getElementById('seq-play');
                const pauseBtn = document.getElementById('seq-pause');
                const stopBtn = document.getElementById('seq-stop');

                if (playBtn) playBtn.disabled = this.isPlaying;
                if (pauseBtn) pauseBtn.disabled = !this.isPlaying;
                if (stopBtn) stopBtn.disabled = !this.isPlaying;
            }

            saveSettings() {
                localStorage.setItem('tonejs-lab-sequencer', JSON.stringify(this.settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('tonejs-lab-sequencer');
                if (saved) {
                    try {
                        this.settings = { ...this.defaults, ...JSON.parse(saved) };
                        this.pattern = [...this.settings.pattern];

                        // Update BPM display
                        const bpmSlider = document.getElementById('seq-bpm');
                        const bpmDisplay = document.getElementById('seq-bpm-value');
                        if (bpmSlider) bpmSlider.value = this.settings.bpm;
                        if (bpmDisplay) bpmDisplay.textContent = this.settings.bpm;

                        // Update step displays
                        this.pattern.forEach((_, index) => this.updateStepDisplay(index));

                        console.log('üìÇ Sequencer settings loaded');
                    } catch (e) {
                        console.warn('Failed to load settings');
                    }
                }
            }

            render() {
                return `
                    <div class="module-header">
                        <h2>Sequencer & Transport</h2>
                        <p>Create patterns and learn about timing and scheduling with Tone.Transport.</p>
                    </div>

                    <div class="info-box">
                        <h4>What is Transport?</h4>
                        <p>Tone.Transport is a global clock that synchronizes all time-based events. Think of it as the master timeline that keeps everything in sync. You can start, stop, and control the tempo (BPM) to schedule musical events.</p>
                    </div>

                    <!-- Transport Controls -->
                    <div class="section">
                        <h3>Transport Controls</h3>
                        <div class="section-description">
                            Control playback with Play, Pause, and Stop. The BPM (beats per minute) determines the speed.
                        </div>

                        <div class="transport-controls">
                            <button class="transport-btn" id="seq-play">‚ñ∂ Play</button>
                            <button class="transport-btn" id="seq-pause" disabled>‚è∏ Pause</button>
                            <button class="transport-btn stop" id="seq-stop" disabled>‚èπ Stop</button>

                            <div class="bpm-control">
                                <label>BPM: <span class="value-display" id="seq-bpm-value">120</span></label>
                                <input type="range" id="seq-bpm" min="60" max="200" step="1" value="120" style="width: 200px;">
                            </div>
                        </div>
                    </div>

                    <!-- Step Sequencer -->
                    <div class="section">
                        <h3>16-Step Sequencer</h3>
                        <div class="section-description">
                            Click squares to toggle steps on/off. Active steps (blue) will play a note. Watch the green highlight show the current step as it plays.
                        </div>

                        <div class="sequencer-grid">
                            ${Array(16).fill(0).map((_, i) =>
                                `<div class="step-cell" data-step="${i}"></div>`
                            ).join('')}
                        </div>
                    </div>

                    <!-- Learning Points -->
                    <div class="section">
                        <h3>Key Concepts</h3>
                        <div class="section-description">
                            <strong>Tone.Sequence:</strong> Schedules a series of events that loop in time.<br>
                            <strong>Transport.start():</strong> Begins the global timeline.<br>
                            <strong>16n:</strong> Musical notation for sixteenth notes (16 per bar).<br>
                            <strong>Scheduling:</strong> Events are scheduled ahead of time for perfect timing.
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // FX & MODULATION MODULE
        // Teaches effects and LFO modulation
        // ============================================
        class FXModule extends BaseModule {
            constructor() {
                super('fx', 'FX & Modulation', '‚ú®');

                // Audio chain
                this.osc1 = null;
                this.osc2 = null;
                this.reverb = null;
                this.delay = null;
                this.distortion = null;
                this.filter = null;
                this.lfo = null;

                // State
                this.defaults = {
                    osc1Waveform: 'sine',
                    osc1Volume: -6,
                    osc2Waveform: 'triangle',
                    osc2Volume: -6,
                    reverbDecay: 1.5,
                    reverbWet: 0.3,
                    reverbBypass: false,
                    delayTime: 0.25,
                    delayFeedback: 0.3,
                    delayWet: 0.3,
                    delayBypass: false,
                    distortionAmount: 0.4,
                    distortionBypass: false,
                    lfoRate: 2,
                    lfoDepth: 1000,
                    lfoBypass: false
                };

                this.settings = { ...this.defaults };
            }

            mount() {
                super.mount();
                this.loadSettings();
                this.createAudioChain();
                this.attachEventListeners();
                this.updateAllDisplays();
                console.log('‚ú® FX module loaded');
            }

            unmount() {
                super.unmount();
                this.disposeAudio();
            }

            createAudioChain() {
                // Create effects
                this.reverb = new Tone.Reverb({
                    decay: this.settings.reverbDecay,
                    wet: this.settings.reverbWet
                }).toDestination();

                this.delay = new Tone.FeedbackDelay({
                    delayTime: this.settings.delayTime,
                    feedback: this.settings.delayFeedback,
                    wet: this.settings.delayWet
                }).toDestination();

                this.distortion = new Tone.Distortion({
                    distortion: this.settings.distortionAmount,
                    wet: 1
                }).connect(this.reverb).connect(this.delay);

                this.filter = new Tone.Filter(1000, 'lowpass').connect(this.distortion);

                // Create LFO for filter modulation
                this.lfo = new Tone.LFO(this.settings.lfoRate, 200, 3000);
                this.lfo.connect(this.filter.frequency);

                // Create dual oscillators
                this.osc1 = new Tone.Synth({
                    oscillator: { type: this.settings.osc1Waveform },
                    envelope: {
                        attack: 0.1,
                        decay: 0.2,
                        sustain: 0.5,
                        release: 0.8
                    },
                    volume: this.settings.osc1Volume
                }).connect(this.filter);

                this.osc2 = new Tone.Synth({
                    oscillator: { type: this.settings.osc2Waveform },
                    envelope: {
                        attack: 0.1,
                        decay: 0.2,
                        sustain: 0.5,
                        release: 0.8
                    },
                    volume: this.settings.osc2Volume
                }).connect(this.filter);

                // Apply bypass states
                this.applyBypassStates();
            }

            disposeAudio() {
                [this.osc1, this.osc2, this.reverb, this.delay, this.distortion, this.filter, this.lfo].forEach(node => {
                    if (node) node.dispose();
                });
            }

            attachEventListeners() {
                // Oscillator 1 controls
                const osc1Wave = document.getElementById('osc1-waveform');
                if (osc1Wave) {
                    osc1Wave.addEventListener('change', (e) => {
                        this.settings.osc1Waveform = e.target.value;
                        this.osc1.oscillator.type = e.target.value;
                        this.saveSettings();
                    });
                }
                this.setupSlider('osc1-volume', 'osc1-volume-value', ' dB', (v) => {
                    this.settings.osc1Volume = v;
                    this.osc1.volume.value = v;
                });

                // Oscillator 2 controls
                const osc2Wave = document.getElementById('osc2-waveform');
                if (osc2Wave) {
                    osc2Wave.addEventListener('change', (e) => {
                        this.settings.osc2Waveform = e.target.value;
                        this.osc2.oscillator.type = e.target.value;
                        this.saveSettings();
                    });
                }
                this.setupSlider('osc2-volume', 'osc2-volume-value', ' dB', (v) => {
                    this.settings.osc2Volume = v;
                    this.osc2.volume.value = v;
                });

                // Reverb controls
                this.setupSlider('fx-reverb-decay', 'fx-reverb-decay-value', 's', (v) => {
                    this.settings.reverbDecay = v;
                    this.reverb.decay = v;
                });
                this.setupSlider('fx-reverb-wet', 'fx-reverb-wet-value', '', (v) => {
                    this.settings.reverbWet = v;
                    this.reverb.wet.value = v;
                });
                this.setupBypass('fx-reverb-bypass', 'reverbBypass', this.reverb);

                // Delay controls
                this.setupSlider('fx-delay-time', 'fx-delay-time-value', 's', (v) => {
                    this.settings.delayTime = v;
                    this.delay.delayTime.value = v;
                });
                this.setupSlider('fx-delay-feedback', 'fx-delay-feedback-value', '', (v) => {
                    this.settings.delayFeedback = v;
                    this.delay.feedback.value = v;
                });
                this.setupSlider('fx-delay-wet', 'fx-delay-wet-value', '', (v) => {
                    this.settings.delayWet = v;
                    this.delay.wet.value = v;
                });
                this.setupBypass('fx-delay-bypass', 'delayBypass', this.delay);

                // Distortion controls
                this.setupSlider('fx-dist-amount', 'fx-dist-amount-value', '', (v) => {
                    this.settings.distortionAmount = v;
                    this.distortion.distortion = v;
                });
                this.setupBypass('fx-dist-bypass', 'distortionBypass', this.distortion);

                // LFO controls
                this.setupSlider('fx-lfo-rate', 'fx-lfo-rate-value', ' Hz', (v) => {
                    this.settings.lfoRate = v;
                    this.lfo.frequency.value = v;
                });
                this.setupSlider('fx-lfo-depth', 'fx-lfo-depth-value', ' Hz', (v) => {
                    this.settings.lfoDepth = v;
                    this.lfo.max = v;
                });
                this.setupBypass('fx-lfo-bypass', 'lfoBypass', this.lfo);

                // Note buttons
                document.querySelectorAll('.fx-note-btn').forEach(btn => {
                    btn.addEventListener('mousedown', (e) => this.playNote(e.target.dataset.note));
                    btn.addEventListener('mouseup', () => this.releaseNote());
                });
            }

            setupSlider(sliderId, displayId, suffix, callback) {
                const slider = document.getElementById(sliderId);
                const display = document.getElementById(displayId);
                if (slider && display) {
                    slider.addEventListener('input', (e) => {
                        const val = parseFloat(e.target.value);
                        display.textContent = val.toFixed(2) + suffix;
                        callback(val);
                        this.saveSettings();
                    });
                }
            }

            setupBypass(btnId, settingKey, audioNode) {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', () => {
                        this.settings[settingKey] = !this.settings[settingKey];
                        this.applyBypassState(btnId, settingKey, audioNode);
                        this.saveSettings();
                    });
                }
            }

            applyBypassStates() {
                this.applyBypassState('fx-reverb-bypass', 'reverbBypass', this.reverb);
                this.applyBypassState('fx-delay-bypass', 'delayBypass', this.delay);
                this.applyBypassState('fx-dist-bypass', 'distortionBypass', this.distortion);
                this.applyBypassState('fx-lfo-bypass', 'lfoBypass', this.lfo);
            }

            applyBypassState(btnId, settingKey, audioNode) {
                const btn = document.getElementById(btnId);
                const bypassed = this.settings[settingKey];

                if (btn) {
                    if (bypassed) {
                        btn.classList.add('bypassed');
                        btn.textContent = 'Bypassed';
                        btn.closest('.fx-unit')?.classList.add('bypassed');
                    } else {
                        btn.classList.remove('bypassed');
                        btn.textContent = 'Active';
                        btn.closest('.fx-unit')?.classList.remove('bypassed');
                    }
                }

                // Toggle audio processing
                if (audioNode) {
                    if (audioNode === this.lfo) {
                        // LFO: start/stop
                        if (bypassed) {
                            this.lfo.stop();
                        } else {
                            this.lfo.start();
                        }
                    } else {
                        // Effects: wet control
                        audioNode.wet.value = bypassed ? 0 : this.settings[settingKey.replace('Bypass', 'Wet')] || 1;
                    }
                }
            }

            async playNote(note) {
                await Tone.start();
                if (this.osc1) {
                    this.osc1.triggerAttack(note);
                }
                if (this.osc2) {
                    this.osc2.triggerAttack(note);
                }
            }

            releaseNote() {
                if (this.osc1) {
                    this.osc1.triggerRelease();
                }
                if (this.osc2) {
                    this.osc2.triggerRelease();
                }
            }

            updateAllDisplays() {
                // Update oscillator waveform selectors
                const osc1Wave = document.getElementById('osc1-waveform');
                const osc2Wave = document.getElementById('osc2-waveform');
                if (osc1Wave) osc1Wave.value = this.settings.osc1Waveform;
                if (osc2Wave) osc2Wave.value = this.settings.osc2Waveform;

                // Update all slider displays
                const params = [
                    ['osc1-volume', 'osc1-volume-value', 'osc1Volume', ' dB'],
                    ['osc2-volume', 'osc2-volume-value', 'osc2Volume', ' dB'],
                    ['fx-reverb-decay', 'fx-reverb-decay-value', 'reverbDecay', 's'],
                    ['fx-reverb-wet', 'fx-reverb-wet-value', 'reverbWet', ''],
                    ['fx-delay-time', 'fx-delay-time-value', 'delayTime', 's'],
                    ['fx-delay-feedback', 'fx-delay-feedback-value', 'delayFeedback', ''],
                    ['fx-delay-wet', 'fx-delay-wet-value', 'delayWet', ''],
                    ['fx-dist-amount', 'fx-dist-amount-value', 'distortionAmount', ''],
                    ['fx-lfo-rate', 'fx-lfo-rate-value', 'lfoRate', ' Hz'],
                    ['fx-lfo-depth', 'fx-lfo-depth-value', 'lfoDepth', ' Hz']
                ];

                params.forEach(([sliderId, displayId, settingKey, suffix]) => {
                    const slider = document.getElementById(sliderId);
                    const display = document.getElementById(displayId);
                    if (slider && display) {
                        slider.value = this.settings[settingKey];
                        display.textContent = this.settings[settingKey].toFixed(2) + suffix;
                    }
                });
            }

            saveSettings() {
                localStorage.setItem('tonejs-lab-fx', JSON.stringify(this.settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('tonejs-lab-fx');
                if (saved) {
                    try {
                        this.settings = { ...this.defaults, ...JSON.parse(saved) };
                        console.log('üìÇ FX settings loaded');
                    } catch (e) {
                        console.warn('Failed to load settings');
                    }
                }
            }

            render() {
                return `
                    <div class="module-header">
                        <h2>FX & Modulation</h2>
                        <p>Transform your sounds with effects and modulation. Learn how to chain effects and use LFOs to create movement.</p>
                    </div>

                    <div class="info-box">
                        <h4>Signal Flow & Effects Chain</h4>
                        <p>Audio flows through a chain: Osc1 + Osc2 ‚Üí Filter ‚Üí Distortion ‚Üí Reverb & Delay ‚Üí Output. Each effect processes the signal and passes it forward. The LFO (Low Frequency Oscillator) modulates the filter cutoff to create wobbling, sweeping sounds.</p>
                    </div>

                    <!-- Oscillator Mix Section -->
                    <div class="oscillator-mix">
                        <h3>Oscillator Mix</h3>
                        <div class="section-description" style="margin-bottom: 20px;">
                            Blend two oscillators with different waveforms to create unique timbres. Adjust each oscillator's volume to find the perfect mix.
                        </div>
                        <div class="oscillators-grid">
                            <div class="oscillator-card">
                                <h4>Oscillator 1</h4>
                                <div class="osc-control">
                                    <label>Waveform</label>
                                    <select id="osc1-waveform">
                                        <option value="sine">Sine</option>
                                        <option value="square">Square</option>
                                        <option value="sawtooth">Sawtooth</option>
                                        <option value="triangle">Triangle</option>
                                    </select>
                                </div>
                                <div class="osc-control">
                                    <div class="volume-display">
                                        <label>Volume</label>
                                        <span id="osc1-volume-value">-6.00 dB</span>
                                    </div>
                                    <input type="range" id="osc1-volume" min="-40" max="0" step="0.5" value="-6">
                                </div>
                            </div>

                            <div class="oscillator-card">
                                <h4>Oscillator 2</h4>
                                <div class="osc-control">
                                    <label>Waveform</label>
                                    <select id="osc2-waveform">
                                        <option value="sine">Sine</option>
                                        <option value="square">Square</option>
                                        <option value="sawtooth">Sawtooth</option>
                                        <option value="triangle">Triangle</option>
                                    </select>
                                </div>
                                <div class="osc-control">
                                    <div class="volume-display">
                                        <label>Volume</label>
                                        <span id="osc2-volume-value">-6.00 dB</span>
                                    </div>
                                    <input type="range" id="osc2-volume" min="-40" max="0" step="0.5" value="-6">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Keyboard -->
                    <div class="section">
                        <h3>Test Sounds</h3>
                        <div class="section-description">
                            Play notes to hear the effects. Hold keys to sustain and hear modulation.
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="note-btn fx-note-btn" data-note="C3">C3</button>
                            <button class="note-btn fx-note-btn" data-note="E3">E3</button>
                            <button class="note-btn fx-note-btn" data-note="G3">G3</button>
                            <button class="note-btn fx-note-btn" data-note="C4">C4</button>
                        </div>
                    </div>

                    <!-- Effects Chain -->
                    <div class="section">
                        <h3>Effects Chain</h3>
                        <div class="section-description">
                            Toggle effects on/off with the bypass button. Adjust parameters to shape the sound.
                        </div>

                        <div class="fx-chain">
                            <!-- Reverb -->
                            <div class="fx-unit">
                                <div class="fx-header">
                                    <div class="fx-title">Reverb</div>
                                    <button class="bypass-toggle" id="fx-reverb-bypass">Active</button>
                                </div>
                                <div class="control-group">
                                    <label>Decay: <span class="value-display" id="fx-reverb-decay-value">1.50s</span></label>
                                    <input type="range" id="fx-reverb-decay" min="0.1" max="10" step="0.1" value="1.5">
                                </div>
                                <div class="control-group">
                                    <label>Wet/Dry: <span class="value-display" id="fx-reverb-wet-value">0.30</span></label>
                                    <input type="range" id="fx-reverb-wet" min="0" max="1" step="0.01" value="0.3">
                                </div>
                            </div>

                            <!-- Delay -->
                            <div class="fx-unit">
                                <div class="fx-header">
                                    <div class="fx-title">Delay</div>
                                    <button class="bypass-toggle" id="fx-delay-bypass">Active</button>
                                </div>
                                <div class="control-group">
                                    <label>Time: <span class="value-display" id="fx-delay-time-value">0.25s</span></label>
                                    <input type="range" id="fx-delay-time" min="0.01" max="1" step="0.01" value="0.25">
                                </div>
                                <div class="control-group">
                                    <label>Feedback: <span class="value-display" id="fx-delay-feedback-value">0.30</span></label>
                                    <input type="range" id="fx-delay-feedback" min="0" max="0.9" step="0.01" value="0.3">
                                </div>
                                <div class="control-group">
                                    <label>Wet/Dry: <span class="value-display" id="fx-delay-wet-value">0.30</span></label>
                                    <input type="range" id="fx-delay-wet" min="0" max="1" step="0.01" value="0.3">
                                </div>
                            </div>

                            <!-- Distortion -->
                            <div class="fx-unit">
                                <div class="fx-header">
                                    <div class="fx-title">Distortion</div>
                                    <button class="bypass-toggle" id="fx-dist-bypass">Active</button>
                                </div>
                                <div class="control-group">
                                    <label>Amount: <span class="value-display" id="fx-dist-amount-value">0.40</span></label>
                                    <input type="range" id="fx-dist-amount" min="0" max="1" step="0.01" value="0.4">
                                </div>
                            </div>

                            <!-- LFO -->
                            <div class="fx-unit">
                                <div class="fx-header">
                                    <div class="fx-title">LFO ‚Üí Filter</div>
                                    <button class="bypass-toggle" id="fx-lfo-bypass">Active</button>
                                </div>
                                <div class="control-group">
                                    <label>Rate: <span class="value-display" id="fx-lfo-rate-value">2.00 Hz</span></label>
                                    <input type="range" id="fx-lfo-rate" min="0.1" max="10" step="0.1" value="2">
                                </div>
                                <div class="control-group">
                                    <label>Depth: <span class="value-display" id="fx-lfo-depth-value">1000.00 Hz</span></label>
                                    <input type="range" id="fx-lfo-depth" min="100" max="5000" step="100" value="1000">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Concepts -->
                    <div class="section">
                        <h3>Key Concepts</h3>
                        <div class="section-description">
                            <strong>Reverb:</strong> Simulates room reflections. Decay = how long it lasts.<br>
                            <strong>Delay:</strong> Repeating echoes. Time = gap between repeats, Feedback = how many repeats.<br>
                            <strong>Distortion:</strong> Adds harmonics and grit by clipping the waveform.<br>
                            <strong>LFO:</strong> Low Frequency Oscillator modulates parameters over time (filter wobble).<br>
                            <strong>Wet/Dry:</strong> Mix between processed (wet) and original (dry) signal.
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // DRONES & OCTAVES MODULE
        // Teaches polyphony and sustained tones
        // ============================================
        class DronesModule extends BaseModule {
            constructor() {
                super('drones', 'Drones & Octaves', 'üé∂');

                // Drone management
                this.drones = []; // Array of {id, note, octave, volume, synth}
                this.nextDroneId = 1;
                this.maxDrones = 6;

                // Available notes (chromatic scale)
                this.notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                this.octaves = [1, 2, 3, 4, 5, 6, 7];

                // Default settings
                this.defaults = {
                    drones: [] // Array of {id, note, octave, volume}
                };

                this.settings = { ...this.defaults, drones: [] };
            }

            mount() {
                super.mount();
                this.loadSettings();
                this.restoreDrones();
                this.attachEventListeners();
                console.log('üé∂ Drones module loaded');
            }

            unmount() {
                super.unmount();
                this.stopAllDrones();
            }

            loadSettings() {
                const saved = localStorage.getItem('toneLab_drones');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        this.settings = { ...this.defaults, ...parsed };
                    } catch (e) {
                        console.warn('Failed to load drones settings');
                    }
                }
            }

            saveSettings() {
                // Save drone configurations (not the synth objects)
                this.settings.drones = this.drones.map(d => ({
                    id: d.id,
                    note: d.note,
                    octave: d.octave,
                    volume: d.volume
                }));
                localStorage.setItem('toneLab_drones', JSON.stringify(this.settings));
            }

            restoreDrones() {
                // Restore saved drones from settings
                if (this.settings.drones && this.settings.drones.length > 0) {
                    this.settings.drones.forEach(droneData => {
                        this.addDrone(droneData.note, droneData.octave, droneData.volume, droneData.id);
                    });
                }
            }

            addDrone(note = 'C', octave = 3, volume = -12, id = null) {
                if (this.drones.length >= this.maxDrones) {
                    return;
                }

                // Create synth for this drone
                const synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: {
                        attack: 0.5,
                        decay: 0,
                        sustain: 1,
                        release: 0.5
                    },
                    volume: volume
                }).toDestination();

                const droneId = id !== null ? id : this.nextDroneId++;
                const fullNote = `${note}${octave}`;

                const drone = {
                    id: droneId,
                    note: note,
                    octave: octave,
                    volume: volume,
                    synth: synth
                };

                this.drones.push(drone);

                // Start the drone
                synth.triggerAttack(fullNote);

                this.updateDronesList();
                this.saveSettings();
            }

            removeDrone(droneId) {
                const index = this.drones.findIndex(d => d.id === droneId);
                if (index !== -1) {
                    const drone = this.drones[index];

                    // Stop and dispose the synth
                    drone.synth.triggerRelease();
                    setTimeout(() => {
                        drone.synth.dispose();
                    }, 600);

                    this.drones.splice(index, 1);
                    this.updateDronesList();
                    this.saveSettings();
                }
            }

            updateDrone(droneId, property, value) {
                const drone = this.drones.find(d => d.id === droneId);
                if (!drone) return;

                if (property === 'note') {
                    drone.note = value;
                    // Restart drone with new note
                    const fullNote = `${drone.note}${drone.octave}`;
                    drone.synth.triggerRelease();
                    setTimeout(() => {
                        drone.synth.triggerAttack(fullNote);
                    }, 100);
                } else if (property === 'octave') {
                    drone.octave = parseInt(value);
                    // Restart drone with new octave
                    const fullNote = `${drone.note}${drone.octave}`;
                    drone.synth.triggerRelease();
                    setTimeout(() => {
                        drone.synth.triggerAttack(fullNote);
                    }, 100);
                } else if (property === 'volume') {
                    drone.volume = parseFloat(value);
                    drone.synth.volume.value = drone.volume;
                    this.updateVolumeDisplay(droneId);
                }

                this.saveSettings();
            }

            updateVolumeDisplay(droneId) {
                const display = document.getElementById(`drone-${droneId}-volume-display`);
                const drone = this.drones.find(d => d.id === droneId);
                if (display && drone) {
                    display.textContent = `${drone.volume.toFixed(1)} dB`;
                }
            }

            stopAllDrones() {
                this.drones.forEach(drone => {
                    drone.synth.triggerRelease();
                    drone.synth.dispose();
                });
                this.drones = [];
            }

            updateDronesList() {
                const list = document.getElementById('dronesList');
                const addBtn = document.getElementById('addDroneBtn');

                if (!list) return;

                if (this.drones.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: var(--text-dim); padding: 40px;">No drones active. Click "Add Drone" to start.</p>';
                } else {
                    list.innerHTML = this.drones.map(drone => `
                        <div class="drone-card">
                            <div class="drone-header">
                                <span class="drone-title">Drone ${drone.id} - ${drone.note}${drone.octave}</span>
                                <button class="remove-drone-btn" data-drone-id="${drone.id}">Remove</button>
                            </div>
                            <div class="drone-controls">
                                <div class="drone-control-group">
                                    <label>Note</label>
                                    <select data-drone-id="${drone.id}" data-property="note">
                                        ${this.notes.map(n => `<option value="${n}" ${n === drone.note ? 'selected' : ''}>${n}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="drone-control-group">
                                    <label>Octave</label>
                                    <select data-drone-id="${drone.id}" data-property="octave">
                                        ${this.octaves.map(o => `<option value="${o}" ${o === drone.octave ? 'selected' : ''}>${o}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="drone-control-group" style="grid-column: 1 / -1;">
                                    <div class="volume-display">
                                        <label>Volume</label>
                                        <span id="drone-${drone.id}-volume-display">${drone.volume.toFixed(1)} dB</span>
                                    </div>
                                    <input
                                        type="range"
                                        min="-40"
                                        max="0"
                                        step="1"
                                        value="${drone.volume}"
                                        data-drone-id="${drone.id}"
                                        data-property="volume"
                                    >
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Update add button state
                if (addBtn) {
                    addBtn.disabled = this.drones.length >= this.maxDrones;
                }
            }

            attachEventListeners() {
                // Add drone button
                const addBtn = document.getElementById('addDroneBtn');
                if (addBtn) {
                    addBtn.addEventListener('click', async () => {
                        await Tone.start();
                        this.addDrone();
                    });
                }

                // Delegate events for drone controls
                const list = document.getElementById('dronesList');
                if (list) {
                    list.addEventListener('click', (e) => {
                        // Remove button
                        if (e.target.classList.contains('remove-drone-btn')) {
                            const droneId = parseInt(e.target.dataset.droneId);
                            this.removeDrone(droneId);
                        }
                    });

                    list.addEventListener('change', (e) => {
                        const droneId = parseInt(e.target.dataset.droneId);
                        const property = e.target.dataset.property;
                        const value = e.target.value;

                        if (droneId && property) {
                            this.updateDrone(droneId, property, value);
                        }
                    });

                    list.addEventListener('input', (e) => {
                        if (e.target.type === 'range') {
                            const droneId = parseInt(e.target.dataset.droneId);
                            const property = e.target.dataset.property;
                            const value = e.target.value;

                            if (droneId && property) {
                                this.updateDrone(droneId, property, value);
                            }
                        }
                    });
                }
            }

            render() {
                return `
                    <div class="module-header">
                        <h2>Drones & Octaves</h2>
                        <p>Create sustained tones and explore polyphony and octave relationships</p>
                    </div>

                    <div class="info-box">
                        <h4>üìö What You'll Learn</h4>
                        <p>
                            <strong>Drones:</strong> Sustained tones that continue indefinitely until stopped.<br>
                            <strong>Polyphony:</strong> Multiple sounds playing simultaneously.<br>
                            <strong>Octaves:</strong> Same note at different frequencies (doubling = up one octave).<br>
                            <strong>Voice Stacking:</strong> Layering multiple tones to create rich, complex sounds.
                        </p>
                    </div>

                    <div class="drones-container">
                        <button id="addDroneBtn" class="add-drone-btn">+ Add Drone</button>
                        <div id="dronesList" class="drones-list"></div>
                    </div>

                    <div class="info-box" style="margin-top: 30px;">
                        <h4>üí° Tips</h4>
                        <p>
                            ‚Ä¢ Try octaves of the same note (e.g., C2, C3, C4) for harmonic layers<br>
                            ‚Ä¢ Experiment with intervals like fifths (C + G) or thirds (C + E)<br>
                            ‚Ä¢ Adjust volumes to balance your drones<br>
                            ‚Ä¢ Maximum ${this.maxDrones} drones can be active at once
                        </p>
                    </div>
                `;
            }
        }

        class VisualizationModule extends BaseModule {
            constructor() {
                super('visualization', 'Visualization', 'üìä');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>üìä Visualization</h3>
                        <p>See your sound with waveform and FFT visualizations</p>
                        <p>Topics: Tone.Waveform, Tone.FFT, canvas drawing, real-time audio viz</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        class MIDIModule extends BaseModule {
            constructor() {
                super('midi', 'MIDI Input', 'üéπ');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>üéπ MIDI Input</h3>
                        <p>Connect MIDI controllers and keyboards to Tone.js</p>
                        <p>Topics: Web MIDI API, note on/off, velocity, CC mapping</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        class AdvancedModule extends BaseModule {
            constructor() {
                super('advanced', 'Advanced', 'üöÄ');
                this.isStub = true;
            }

            render() {
                return `
                    <div class="stub-content">
                        <h3>üöÄ Advanced Topics</h3>
                        <p>Explore advanced synthesis and sampling techniques</p>
                        <p>Topics: PolySynth, Sampler, granular synthesis, custom instruments</p>
                        <span class="coming-soon">Coming Soon</span>
                    </div>
                `;
            }
        }

        // ============================================
        // MAIN APPLICATION CONTROLLER
        // Manages module switching and navigation
        // ============================================
        class ToneLabApp {
            constructor() {
                this.modules = [];
                this.currentModule = null;
                this.navContainer = document.getElementById('navList');
                this.contentContainer = document.getElementById('moduleContainer');

                this.init();
            }

            init() {
                // Register all modules
                this.registerModule(new BasicsModule());
                this.registerModule(new SequencerModule());
                this.registerModule(new FXModule());
                this.registerModule(new DronesModule());
                this.registerModule(new VisualizationModule());
                this.registerModule(new MIDIModule());
                this.registerModule(new AdvancedModule());

                // Build navigation
                this.buildNavigation();

                // Setup mobile menu
                this.setupMobileMenu();

                // Load first module
                this.switchToModule('basics');

                console.log('üöÄ Tone.js Learning Lab initialized');
            }

            // Setup mobile menu toggle
            setupMobileMenu() {
                const menuToggle = document.getElementById('menuToggle');
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('sidebarBackdrop');

                if (!menuToggle || !sidebar || !backdrop) return;

                // Toggle menu
                const toggleMenu = () => {
                    const isOpen = sidebar.classList.contains('open');

                    if (isOpen) {
                        sidebar.classList.remove('open');
                        backdrop.classList.remove('active');
                        menuToggle.classList.remove('active');
                    } else {
                        sidebar.classList.add('open');
                        backdrop.classList.add('active');
                        menuToggle.classList.add('active');
                    }
                };

                // Menu button click
                menuToggle.addEventListener('click', toggleMenu);

                // Backdrop click closes menu
                backdrop.addEventListener('click', toggleMenu);

                // Close menu when nav item clicked (on mobile)
                this.navContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.nav-item') && !e.target.closest('.nav-item').classList.contains('disabled')) {
                        // Small delay to let the click register
                        setTimeout(() => {
                            if (window.innerWidth <= 768) {
                                toggleMenu();
                            }
                        }, 200);
                    }
                });
            }

            // Register a new module
            registerModule(module) {
                this.modules.push(module);
            }

            // Build the navigation sidebar
            buildNavigation() {
                this.navContainer.innerHTML = '';

                this.modules.forEach(module => {
                    const navItem = document.createElement('li');
                    navItem.className = 'nav-item';
                    if (module.isStub) navItem.classList.add('disabled');
                    navItem.dataset.moduleId = module.id;

                    navItem.innerHTML = `
                        <span class="nav-item-icon">${module.icon}</span>
                        <span class="nav-item-text">${module.title}</span>
                        ${module.isStub ? '<span class="nav-item-badge">Soon</span>' : ''}
                    `;

                    if (!module.isStub) {
                        navItem.addEventListener('click', () => this.switchToModule(module.id));
                    }

                    this.navContainer.appendChild(navItem);
                });
            }

            // Switch to a different module
            switchToModule(moduleId) {
                // Find the module
                const module = this.modules.find(m => m.id === moduleId);
                if (!module || module.isStub) return;

                // Unmount current module
                if (this.currentModule) {
                    this.currentModule.unmount();
                }

                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.moduleId === moduleId) {
                        item.classList.add('active');
                    }
                });

                // Render new module
                this.contentContainer.innerHTML = `
                    <div class="module active" id="module-${module.id}">
                        ${module.render()}
                    </div>
                `;

                // Mount new module
                this.currentModule = module;
                this.currentModule.mount();
            }
        }

        // ============================================
        // START THE APPLICATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            window.toneLabApp = new ToneLabApp();
        });

        /* ============================================
           ROADMAP FOR FUTURE MODULES
           ============================================

           This section outlines how each stub module would be implemented.
           Each follows the same pattern as BasicsModule.

           -------------------------------------------
           SEQUENCER & TRANSPORT MODULE
           -------------------------------------------
           Purpose: Teach pattern-based music creation and timing

           Key Components:
           - Tone.Transport (global clock/scheduler)
           - Tone.Sequence or Tone.Pattern for note patterns
           - Step sequencer UI (8 or 16 steps)
           - BPM control
           - Play/Pause/Stop controls
           - Step editing (toggle notes on/off)

           Implementation:
           class SequencerModule extends BaseModule {
               - Create Transport controls (start, stop, pause)
               - Build step sequencer grid (16 steps √ó 4 tracks)
               - Use Tone.Sequence to schedule notes
               - Add BPM slider (60-200)
               - Visual feedback: highlight current step
               - Allow pattern saving/loading
           }

           Teaching Focus:
           - Transport is global (shared across app)
           - Scheduling vs immediate playback
           - Timing and quantization
           - Loop points and repeat

           -------------------------------------------
           FX & MODULATION MODULE
           -------------------------------------------
           Purpose: Add effects and LFO-driven modulation

           Key Components:
           - Effects chain: Reverb, Delay, Distortion, Chorus
           - Tone.LFO for modulation
           - Effect bypass toggles
           - Wet/dry mix controls
           - LFO rate and depth

           Implementation:
           class FXModule extends BaseModule {
               - Create synth ‚Üí effects chain ‚Üí destination
               - Add reverb (room size, decay)
               - Add delay (time, feedback)
               - Add distortion (amount)
               - Create LFO ‚Üí modulate filter cutoff
               - Visual representation of signal flow
           }

           Teaching Focus:
           - Signal routing (connect vs toDestination)
           - Wet/dry mixing
           - LFO modulation targets
           - Effect order matters

           -------------------------------------------
           DRONES & OCTAVES MODULE
           -------------------------------------------
           Purpose: Sustained tones and polyphony

           Key Components:
           - Tone.PolySynth for multiple voices
           - Octave selector (-2 to +2)
           - Drone lock (sustained note)
           - Voice stacking (play multiple notes)
           - Chord builder

           Implementation:
           class DronesModule extends BaseModule {
               - Use PolySynth for polyphony
               - Add octave transpose control
               - Drone toggle locks a note
               - Build chord presets (maj, min, 7th)
               - Visual: show active voices
           }

           Teaching Focus:
           - PolySynth vs monophonic Synth
           - Voice allocation
           - Note stacking and chords
           - Octave relationships

           -------------------------------------------
           VISUALIZATION MODULE
           -------------------------------------------
           Purpose: Real-time audio visualization

           Key Components:
           - Tone.Waveform (time-domain oscilloscope)
           - Tone.FFT (frequency spectrum)
           - Canvas drawing
           - Animation loop

           Implementation:
           class VisualizationModule extends BaseModule {
               - Create canvas element
               - Connect synth ‚Üí Waveform analyzer
               - requestAnimationFrame loop
               - Draw waveform or FFT
               - Add visualization style toggles
           }

           Teaching Focus:
           - Analyzers don't affect audio (passive)
           - Time vs frequency domain
           - getValue() returns typed array
           - Canvas drawing basics

           -------------------------------------------
           MIDI INPUT MODULE
           -------------------------------------------
           Purpose: Connect external MIDI controllers

           Key Components:
           - navigator.requestMIDIAccess()
           - MIDI message parsing
           - Note on/off ‚Üí synth
           - Velocity mapping
           - CC to parameter mapping

           Implementation:
           class MIDIModule extends BaseModule {
               - Request MIDI access
               - List available devices
               - Parse note on/off (0x90, 0x80)
               - Map velocity to volume
               - Map CC to filter cutoff
               - Visual: show incoming messages
           }

           Teaching Focus:
           - Web MIDI API (separate from Tone.js)
           - MIDI message structure
           - Note on/off, velocity, CC
           - Mapping MIDI to parameters

           -------------------------------------------
           ADVANCED MODULE
           -------------------------------------------
           Purpose: Complex synthesis and sampling

           Key Components:
           - Tone.Sampler (load audio files)
           - Tone.PolySynth with custom voice
           - Granular synthesis concepts
           - Custom instrument creation

           Implementation:
           class AdvancedModule extends BaseModule {
               - Load samples into Sampler
               - Create PolySynth with FMSynth
               - Build custom instrument class
               - Show signal routing diagrams
               - Performance optimization tips
           }

           Teaching Focus:
           - Sampler vs Synth
           - Creating instrument classes
           - Performance considerations
           - Advanced routing

           -------------------------------------------
           GENERAL IMPLEMENTATION PATTERN
           -------------------------------------------

           Each module follows this structure:

           1. Extend BaseModule
           2. Define constructor with defaults
           3. Implement mount() - create Tone.js objects
           4. Implement unmount() - dispose objects
           5. Implement render() - return HTML string
           6. Add event listeners in mount()
           7. Clean up in unmount()
           8. Save/load state via localStorage

           Module Lifecycle:
           - User clicks nav item
           - App calls currentModule.unmount()
           - App renders new module HTML
           - App calls newModule.mount()

           This ensures clean state management and
           prevents audio resource leaks.

           ============================================ */
    </script>
</body>
</html>
